# Fastfile for Android
# このファイルにはfastlaneのLane定義が含まれます

require "base64"
require "fileutils"

default_platform(:android)

def ensure_android_release_signing!
  required = %w[KEYSTORE_FILE KEYSTORE_PASSWORD KEY_ALIAS KEY_PASSWORD]
  missing = required.select { |key| ENV[key].to_s.strip.empty? }
  UI.user_error!("Missing signing env vars: #{missing.join(', ')}") unless missing.empty?

  android_dir = File.expand_path("..", __dir__) # .../android/fastlane -> .../android
  app_dir = File.join(android_dir, "app")
  FileUtils.mkdir_p(app_dir)

  keystore_out = File.join(app_dir, "upload-keystore.jks")
  keystore_input = ENV["KEYSTORE_FILE"].to_s.strip
  if File.exist?(keystore_input)
    FileUtils.cp(keystore_input, keystore_out)
  else
    decoded = Base64.decode64(keystore_input)
    UI.user_error!("KEYSTORE_FILE must be a file path or base64-encoded keystore") if decoded.bytesize < 1024
    File.binwrite(keystore_out, decoded)
  end
  File.chmod(0o600, keystore_out) rescue nil

  key_properties = File.join(android_dir, "key.properties")
  File.write(
    key_properties,
    <<~PROPS
      storePassword=#{ENV["KEYSTORE_PASSWORD"]}
      keyPassword=#{ENV["KEY_PASSWORD"]}
      keyAlias=#{ENV["KEY_ALIAS"]}
      storeFile=app/upload-keystore.jks
    PROPS
  )
end

platform :android do
  # ビルド前の準備
  before_all do
    # protoスタブの生成（CI環境ではスキップ可能）
    unless ENV["SKIP_BUF_GENERATE"] == "true"
      # bufコマンドが利用可能かつBSRにアクセス可能な場合のみ実行
      result = sh("cd ../.. && buf generate", error_callback: ->(error) {
        UI.important("⚠️ buf generate failed, using existing proto stubs: #{error}")
      }) rescue nil
    else
      UI.message("⏭️ Skipping buf generate (SKIP_BUF_GENERATE=true)")
    end
    # Flutterの依存関係を取得
    sh("cd ../.. && flutter pub get")
  end

  # アプリをビルドするLane（デバッグ用）
  desc "Build the Android app (debug mode)"
  lane :build_debug do
    # Flutterでデバッグビルド
    sh("cd ../.. && flutter build apk --debug")
    
    UI.success("✅ Debug build completed successfully!")
    UI.important("APK location: build/app/outputs/flutter-apk/app-debug.apk")
  end

  # アプリをビルドするLane（リリース用・署名なし）
  desc "Build the Android app (release mode - no signing)"
  lane :build_test do
    # Flutterでリリースビルド（署名なし）
    sh("cd ../.. && flutter build apk --release")
    
    UI.success("✅ Release build completed successfully! (No signing)")
    UI.important("APK location: build/app/outputs/flutter-apk/app-release.apk")
    UI.important("Note: This is a test build without code signing. For production, use the 'build' lane.")
  end

  # アプリをビルドするLane（リリース用・署名あり）
  desc "Build the Android app (release mode - with signing)"
  lane :build do
    ensure_android_release_signing!
    sh("cd ../.. && flutter build apk --release")
    
    UI.success("✅ Release build completed successfully!")
    UI.important("APK location: build/app/outputs/flutter-apk/app-release.apk")
  end

  # App BundleをビルドするLane（Google Play用）
  desc "Build the Android App Bundle (for Google Play)"
  lane :build_bundle do
    ensure_android_release_signing!
    sh("cd ../.. && flutter build appbundle --release")
    
    UI.success("✅ App Bundle build completed successfully!")
    UI.important("AAB location: build/app/outputs/bundle/release/app-release.aab")
  end

  # テストを実行するLane
  desc "Run tests"
  lane :test do
    # Flutterのテストを実行
    sh("cd ../.. && flutter test")
    
    UI.success("✅ Tests completed successfully!")
  end

  # ビルドとテストの両方を実行
  desc "Build and test"
  lane :build_and_test do
    test
    build_test
  end

  # エラー発生時の処理
  error do |lane, exception|
    UI.error("❌ Error in lane #{lane}: #{exception.message}")
    UI.error(exception.backtrace.join("\n"))
  end
end
