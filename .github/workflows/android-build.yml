name: Android Build

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ“ãƒ«ãƒ‰ (true/false)'
        required: false
        default: 'false'
        type: boolean

env:
  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ãªã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
  # æ‰‹å‹•å®Ÿè¡Œæ™‚ã« skip_cache=true ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ãªã„
  CACHE_KEY_SUFFIX: ${{ github.event.inputs.skip_cache == 'true' && github.run_id || 'v1' }}

jobs:
  build:
    name: Build Android App
    runs-on: [self-hosted, linux, android]
    timeout-minutes: 60
    env:
      KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      BUF_TOKEN: ${{ secrets.BUF_TOKEN }}
      SKIP_BUF_GENERATE: "true"  # protoã‚¹ã‚¿ãƒ–ã¯æ—¢ã«ç”Ÿæˆæ¸ˆã¿
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          set-safe-directory: false

      - name: Prepare runner directories
        run: |
          echo "RUNNER_TEMP=$RUNNER_TEMP"
          echo "RUNNER_TOOL_CACHE=$RUNNER_TOOL_CACHE"
          mkdir -p "$RUNNER_TEMP" "$RUNNER_TOOL_CACHE"

      # Flutter SDK ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        timeout-minutes: 5
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true  # Flutter SDKã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
          cache-key: flutter-${{ runner.os }}-3.38.5-${{ env.CACHE_KEY_SUFFIX }}

      - name: Verify Flutter
        run: |
          which flutter
          flutter --version

      # Pub packages ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache Pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}-${{ env.CACHE_KEY_SUFFIX }}
          restore-keys: |
            pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}-v1
            pub-cache-${{ runner.os }}-

      # Gradle ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('android/build.gradle', 'android/app/build.gradle', 'android/gradle/wrapper/gradle-wrapper.properties') }}-${{ env.CACHE_KEY_SUFFIX }}
          restore-keys: |
            gradle-${{ runner.os }}-${{ hashFiles('android/build.gradle', 'android/app/build.gradle', 'android/gradle/wrapper/gradle-wrapper.properties') }}-v1
            gradle-${{ runner.os }}-

      # Ruby Bundler ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache Ruby Bundler
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: bundler-${{ runner.os }}-${{ hashFiles('Gemfile.lock') }}-${{ env.CACHE_KEY_SUFFIX }}
          restore-keys: |
            bundler-${{ runner.os }}-${{ hashFiles('Gemfile.lock') }}-v1
            bundler-${{ runner.os }}-

      - name: Setup Android SDK
        run: |
          # Self-hostedãƒ©ãƒ³ãƒŠãƒ¼ã§ã¯æ—¢å­˜ã®Android SDKã‚’æ¤œå‡ºã—ã¦ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
          # ä¸€èˆ¬çš„ãªAndroid SDKã®ãƒ‘ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
          if [ -d "$HOME/.android/sdk" ]; then
            ANDROID_SDK_ROOT="$HOME/.android/sdk"
          elif [ -d "$HOME/android-sdk" ]; then
            ANDROID_SDK_ROOT="$HOME/android-sdk"
          elif [ -d "/opt/android-sdk" ]; then
            ANDROID_SDK_ROOT="/opt/android-sdk"
          elif [ -n "$ANDROID_HOME" ] && [ -d "$ANDROID_HOME" ]; then
            ANDROID_SDK_ROOT="$ANDROID_HOME"
          elif [ -n "$ANDROID_SDK_ROOT" ] && [ -d "$ANDROID_SDK_ROOT" ]; then
            # æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
            ANDROID_SDK_ROOT="$ANDROID_SDK_ROOT"
          else
            echo "âŒ Android SDKãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®ãƒ‘ã‚¹ã«Android SDKã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:"
            echo "  - $HOME/.android/sdk"
            echo "  - $HOME/android-sdk"
            echo "  - /opt/android-sdk"
            exit 1
          fi
          
          echo "âœ… Android SDK found at: $ANDROID_SDK_ROOT"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          
          # PATHã«è¿½åŠ 
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/16.0/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/emulator" >> $GITHUB_PATH
          
          # ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèª
          export ANDROID_SDK_ROOT
          export ANDROID_HOME="$ANDROID_SDK_ROOT"
          export PATH="$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/cmdline-tools/16.0/bin:$ANDROID_SDK_ROOT/platform-tools"
          
          echo "ðŸ“‹ Android SDKç’°å¢ƒå¤‰æ•°:"
          echo "  ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          echo "  ANDROID_HOME=$ANDROID_HOME"
          
          # sdkmanagerãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
          if command -v sdkmanager >/dev/null 2>&1; then
            echo "âœ… sdkmanager found: $(which sdkmanager)"
            sdkmanager --version || true
          else
            echo "âš ï¸  sdkmanager not found in PATH, checking common locations..."
            if [ -f "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
              echo "âœ… Found sdkmanager at: $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
            elif [ -f "$ANDROID_SDK_ROOT/cmdline-tools/16.0/bin/sdkmanager" ]; then
              echo "âœ… Found sdkmanager at: $ANDROID_SDK_ROOT/cmdline-tools/16.0/bin/sdkmanager"
            else
              echo "âŒ sdkmanager not found"
              exit 1
            fi
          fi

      - name: Setup buf
        uses: bufbuild/buf-setup-action@v1

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
        timeout-minutes: 5

      - name: Check Ruby
        run: |
          ruby -v
          bundle -v

      - name: Check Java
        run: |
          java -version
          javac -version

      # Android SDK packages ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆself-hostedãƒ©ãƒ³ãƒŠãƒ¼ã§ã¯æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆã‚¹ã‚­ãƒƒãƒ—ï¼‰
      - name: Install Android SDK packages
        run: |
          # sdkmanagerã®ãƒ‘ã‚¹ã‚’å–å¾—
          SDKMANAGER=""
          if command -v sdkmanager >/dev/null 2>&1; then
            SDKMANAGER="sdkmanager"
          elif [ -f "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          elif [ -f "$ANDROID_SDK_ROOT/cmdline-tools/16.0/bin/sdkmanager" ]; then
            SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/16.0/bin/sdkmanager"
          else
            echo "âŒ sdkmanager not found"
            exit 1
          fi
          
          echo "ðŸ“¦ Using sdkmanager: $SDKMANAGER"
          
          # Check if packages are already installed
          if ! "$SDKMANAGER" --list_installed 2>/dev/null | grep -q "platforms;android-36"; then
            echo "Installing Android SDK packages..."
            yes | "$SDKMANAGER" --licenses || true
            "$SDKMANAGER" --install \
              "platform-tools" \
              "platforms;android-36" \
              "build-tools;36.0.0"
          else
            echo "Android SDK packages already installed, skipping..."
          fi

      # Gradleã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–æ™‚ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
      - name: Clean Gradle cache
        if: ${{ github.event.inputs.skip_cache == 'true' }}
        run: |
          echo "Cleaning Gradle cache..."
          rm -rf ~/.gradle/caches/8.9/transforms
          rm -rf ~/.gradle/caches/journal-1
          rm -rf android/.gradle
          echo "Gradle cache cleaned"

      - name: Install dependencies
        run: |
          # Flutter pub get with cache
          flutter pub get
          # Bundle install with deployment mode for faster installs
          cd android/fastlane && bundle config set --local path '../../vendor/bundle' && bundle install --jobs 4 --retry 3

      - name: Generate env.g.dart for CI builds
        run: |
          # Generate env.g.dart directly without using build_runner
          # This avoids conflicts with other generated files
          chmod +x scripts/generate_env_g_dart_for_ci.sh
          ./scripts/generate_env_g_dart_for_ci.sh
          head -20 lib/presentations/env.g.dart

      - name: Generate firebase_options.dart for CI builds
        run: |
          # Generate dummy firebase_options.dart for CI builds
          chmod +x scripts/generate_firebase_options_for_ci.sh
          ./scripts/generate_firebase_options_for_ci.sh

      - name: Generate google-services.json for CI builds
        run: |
          # Generate dummy google-services.json for CI builds
          chmod +x scripts/generate_google_services_for_ci.sh
          ./scripts/generate_google_services_for_ci.sh

      - name: Run fastlane build (debug mode)
        run: |
          make android-build-debug
        continue-on-error: true

      - name: Run fastlane build (test mode - no signing)
        run: |
          make android-build-test

      - name: Run fastlane build (with code signing)
        if: ${{ env.KEYSTORE_FILE != '' && env.KEYSTORE_PASSWORD != '' && env.KEY_ALIAS != '' && env.KEY_PASSWORD != '' }}
        run: |
          make android-build
        continue-on-error: true

      - name: Run fastlane build bundle (for Google Play)
        if: ${{ env.KEYSTORE_FILE != '' && env.KEYSTORE_PASSWORD != '' && env.KEY_ALIAS != '' && env.KEY_PASSWORD != '' }}
        run: |
          make android-build-bundle
        continue-on-error: true

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            build/app/outputs/flutter-apk/
            build/app/outputs/bundle/
          retention-days: 7
          if-no-files-found: ignore

      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build artifacts are available in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Debug APK: \`build/app/outputs/flutter-apk/app-debug.apk\`" >> $GITHUB_STEP_SUMMARY
          echo "- Release APK: \`build/app/outputs/flutter-apk/app-release.apk\`" >> $GITHUB_STEP_SUMMARY
          echo "- App Bundle: \`build/app/outputs/bundle/release/app-release.aab\`" >> $GITHUB_STEP_SUMMARY
