name: Android Build

on:
  push:
    branches:
      - main
  workflow_dispatch: # 手動実行も可能

jobs:
  build:
    name: Build Android App
    runs-on: [self-hosted, linux, android]
    env:
      KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      BUF_TOKEN: ${{ secrets.BUF_TOKEN }}
      SKIP_BUF_GENERATE: "true"  # protoスタブは既に生成済み
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          set-safe-directory: false

      - name: Prepare runner directories
        run: |
          echo "RUNNER_TEMP=$RUNNER_TEMP"
          echo "RUNNER_TOOL_CACHE=$RUNNER_TOOL_CACHE"
          mkdir -p "$RUNNER_TEMP" "$RUNNER_TOOL_CACHE"

      - name: Clear cached Flutter SDK
        run: |
          echo "RUNNER_TOOL_CACHE=$RUNNER_TOOL_CACHE"
          rm -rf "${RUNNER_TOOL_CACHE%/}/flutter" || true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: false

      - name: Verify Flutter
        run: |
          which flutter
          ls -la "$(which flutter)"
          test -s "$(which flutter)"
          flutter --version

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup buf
        uses: bufbuild/buf-setup-action@v1

      - name: Check Ruby
        run: |
          ruby -v
          bundle -v

      - name: Check Java
        run: |
          java -version
          javac -version

      - name: Install Android SDK packages
        run: |
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-36" \
            "build-tools;36.0.0"

      - name: Install dependencies
        run: |
          make android-setup

      - name: Create .env file for build
        run: |
          cat > .env << 'EOF'
          REVENUE_CAT_GOOGLE_PUBLIC_API_KEY=${{ secrets.REVENUE_CAT_GOOGLE_PUBLIC_API_KEY || 'dummy_key' }}
          REVENUE_CAT_IOS_PUBLIC_API_KEY=${{ secrets.REVENUE_CAT_IOS_PUBLIC_API_KEY || 'dummy_key' }}
          RECAPTCHA_KEY_ANDROID=${{ secrets.RECAPTCHA_KEY_ANDROID || 'dummy_key' }}
          RECAPTCHA_KEY_IOS=${{ secrets.RECAPTCHA_KEY_IOS || 'dummy_key' }}
          LINE_CHANNEL_ID=${{ secrets.LINE_CHANNEL_ID || 'dummy_key' }}
          LINE_OAUTH_PROVIDER_ID=${{ secrets.LINE_OAUTH_PROVIDER_ID || 'dummy_key' }}
          SENTRY_DSN=${{ secrets.SENTRY_DSN || 'dummy_key' }}
          ADJUST_TOKEN=${{ secrets.ADJUST_TOKEN || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_PURCHASE_LP_100=${{ secrets.ADJUST_EVENT_TOKEN_PURCHASE_LP_100 || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_PURCHASE_MP_100=${{ secrets.ADJUST_EVENT_TOKEN_PURCHASE_MP_100 || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_PURCHASE_LP_10=${{ secrets.ADJUST_EVENT_TOKEN_PURCHASE_LP_10 || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_PURCHASE_MP_10=${{ secrets.ADJUST_EVENT_TOKEN_PURCHASE_MP_10 || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_PURCHASE_PRIVATE_MODE_1M=${{ secrets.ADJUST_EVENT_TOKEN_PURCHASE_PRIVATE_MODE_1M || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_PURCHASE_PRIVATE_MODE_3M=${{ secrets.ADJUST_EVENT_TOKEN_PURCHASE_PRIVATE_MODE_3M || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_PURCHASE_PRIVATE_MODE_6M=${{ secrets.ADJUST_EVENT_TOKEN_PURCHASE_PRIVATE_MODE_6M || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_1M_FEMALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_1M_FEMALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_1M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_1M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_BASIC_1M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_BASIC_1M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_3M_FEMALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_3M_FEMALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_3M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_3M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_BASIC_3M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_BASIC_3M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_6M_FEMALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_6M_FEMALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_6M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_PREMIUM_6M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_BASIC_6M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_BASIC_6M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_AUTO_PREMIUM_1M_FEMALE=${{ secrets.ADJUST_EVENT_TOKEN_AUTO_PREMIUM_1M_FEMALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_AUTO_PREMIUM_1M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_AUTO_PREMIUM_1M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_AUTO_BASIC_1M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_AUTO_BASIC_1M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_AUTO_PREMIUM_3M_FEMALE=${{ secrets.ADJUST_EVENT_TOKEN_AUTO_PREMIUM_3M_FEMALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_AUTO_PREMIUM_3M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_AUTO_PREMIUM_3M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_AUTO_BASIC_3M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_AUTO_BASIC_3M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_AUTO_PREMIUM_6M_FEMALE=${{ secrets.ADJUST_EVENT_TOKEN_AUTO_PREMIUM_6M_FEMALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_AUTO_PREMIUM_6M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_AUTO_PREMIUM_6M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_AUTO_BASIC_6M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_AUTO_BASIC_6M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_CANCEL_AUTO_RENEWAL=${{ secrets.ADJUST_EVENT_TOKEN_CANCEL_AUTO_RENEWAL || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_IDENTITY_VERIFICATION=${{ secrets.ADJUST_EVENT_TOKEN_IDENTITY_VERIFICATION || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_1M_FEMALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_1M_FEMALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_1M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_1M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_BASIC_1M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_BASIC_1M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_3M_FEMALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_3M_FEMALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_3M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_3M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_BASIC_3M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_BASIC_3M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_6M_FEMALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_6M_FEMALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_6M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_PREMIUM_6M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_BASIC_6M_MALE=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_DISCOUNT_BASIC_6M_MALE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_SINGLE_VERIFICATION=${{ secrets.ADJUST_EVENT_TOKEN_SINGLE_VERIFICATION || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_REGISTRATION_COMPLETE=${{ secrets.ADJUST_EVENT_TOKEN_REGISTRATION_COMPLETE || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_AUTO_RENEWAL=${{ secrets.ADJUST_EVENT_TOKEN_AUTO_RENEWAL || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_CHAT_TOPICS=${{ secrets.ADJUST_EVENT_TOKEN_CHAT_TOPICS || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_ACCOUNT_WITHDRAWAL=${{ secrets.ADJUST_EVENT_TOKEN_ACCOUNT_WITHDRAWAL || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_REPORT=${{ secrets.ADJUST_EVENT_TOKEN_REPORT || 'dummy_key' }}
          ADJUST_EVENT_TOKEN_HIDE=${{ secrets.ADJUST_EVENT_TOKEN_HIDE || 'dummy_key' }}
          EOF
          echo "Created .env file"

      - name: Generate env.g.dart with build_runner
        run: |
          dart run build_runner build --delete-conflicting-outputs --build-filter="lib/presentations/env.g.dart"

      - name: Run fastlane build (debug mode)
        run: |
          make android-build-debug
        continue-on-error: true

      - name: Run fastlane build (test mode - no signing)
        run: |
          make android-build-test

      - name: Run fastlane build (with code signing)
        if: ${{ env.KEYSTORE_FILE != '' && env.KEYSTORE_PASSWORD != '' && env.KEY_ALIAS != '' && env.KEY_PASSWORD != '' }}
        run: |
          make android-build
        continue-on-error: true

      - name: Run fastlane build bundle (for Google Play)
        if: ${{ env.KEYSTORE_FILE != '' && env.KEYSTORE_PASSWORD != '' && env.KEY_ALIAS != '' && env.KEY_PASSWORD != '' }}
        run: |
          make android-build-bundle
        continue-on-error: true

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            build/app/outputs/flutter-apk/
            build/app/outputs/bundle/
          retention-days: 7
          if-no-files-found: ignore

      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build artifacts are available in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Debug APK: \`build/app/outputs/flutter-apk/app-debug.apk\`" >> $GITHUB_STEP_SUMMARY
          echo "- Release APK: \`build/app/outputs/flutter-apk/app-release.apk\`" >> $GITHUB_STEP_SUMMARY
          echo "- App Bundle: \`build/app/outputs/bundle/release/app-release.aab\`" >> $GITHUB_STEP_SUMMARY
