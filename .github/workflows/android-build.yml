name: Android Build

on:
  push:
    branches:
      - main
  workflow_dispatch: # 手動実行も可能

jobs:
  build:
    name: Build Android App
    runs-on: [self-hosted, linux, android]
    env:
      KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      BUF_TOKEN: ${{ secrets.BUF_TOKEN }}
      SKIP_BUF_GENERATE: "true"  # protoスタブは既に生成済み
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          set-safe-directory: false

      - name: Prepare runner directories
        run: |
          echo "RUNNER_TEMP=$RUNNER_TEMP"
          echo "RUNNER_TOOL_CACHE=$RUNNER_TOOL_CACHE"
          mkdir -p "$RUNNER_TEMP" "$RUNNER_TOOL_CACHE"

      - name: Clear cached Flutter SDK
        run: |
          echo "RUNNER_TOOL_CACHE=$RUNNER_TOOL_CACHE"
          rm -rf "${RUNNER_TOOL_CACHE%/}/flutter" || true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'
          channel: 'stable'
          cache: false

      - name: Verify Flutter
        run: |
          which flutter
          ls -la "$(which flutter)"
          test -s "$(which flutter)"
          flutter --version

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup buf
        uses: bufbuild/buf-setup-action@v1

      - name: Check Ruby
        run: |
          ruby -v
          bundle -v

      - name: Check Java
        run: |
          java -version
          javac -version

      - name: Install Android SDK packages
        run: |
          sdkmanager --install \
            "platform-tools" \
            "platforms;android-36" \
            "build-tools;36.0.0"

      - name: Install dependencies
        run: |
          make android-setup

      - name: Generate env.g.dart for CI builds
        run: |
          # Generate env.g.dart directly without using build_runner
          # This avoids conflicts with other generated files
          chmod +x scripts/generate_env_g_dart_for_ci.sh
          ./scripts/generate_env_g_dart_for_ci.sh
          head -20 lib/presentations/env.g.dart

      - name: Generate firebase_options.dart for CI builds
        run: |
          # Generate dummy firebase_options.dart for CI builds
          chmod +x scripts/generate_firebase_options_for_ci.sh
          ./scripts/generate_firebase_options_for_ci.sh

      - name: Generate google-services.json for CI builds
        run: |
          # Generate dummy google-services.json for CI builds
          chmod +x scripts/generate_google_services_for_ci.sh
          ./scripts/generate_google_services_for_ci.sh

      - name: Run fastlane build (debug mode)
        run: |
          make android-build-debug
        continue-on-error: true

      - name: Run fastlane build (test mode - no signing)
        run: |
          make android-build-test

      - name: Run fastlane build (with code signing)
        if: ${{ env.KEYSTORE_FILE != '' && env.KEYSTORE_PASSWORD != '' && env.KEY_ALIAS != '' && env.KEY_PASSWORD != '' }}
        run: |
          make android-build
        continue-on-error: true

      - name: Run fastlane build bundle (for Google Play)
        if: ${{ env.KEYSTORE_FILE != '' && env.KEYSTORE_PASSWORD != '' && env.KEY_ALIAS != '' && env.KEY_PASSWORD != '' }}
        run: |
          make android-build-bundle
        continue-on-error: true

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            build/app/outputs/flutter-apk/
            build/app/outputs/bundle/
          retention-days: 7
          if-no-files-found: ignore

      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build artifacts are available in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Debug APK: \`build/app/outputs/flutter-apk/app-debug.apk\`" >> $GITHUB_STEP_SUMMARY
          echo "- Release APK: \`build/app/outputs/flutter-apk/app-release.apk\`" >> $GITHUB_STEP_SUMMARY
          echo "- App Bundle: \`build/app/outputs/bundle/release/app-release.aab\`" >> $GITHUB_STEP_SUMMARY
