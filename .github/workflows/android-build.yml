name: Android Build

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'キャッシュを無効化してビルド (true/false)'
        required: false
        default: 'false'
        type: boolean

env:
  # キャッシュを無効化する場合、ランダムなサフィックスを追加
  # 手動実行時に skip_cache=true を指定するとキャッシュを使用しない
  CACHE_KEY_SUFFIX: ${{ github.event.inputs.skip_cache == 'true' && github.run_id || 'v1' }}

jobs:
  build:
    name: Build Android App
    runs-on: [self-hosted, linux, android]
    env:
      KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      BUF_TOKEN: ${{ secrets.BUF_TOKEN }}
      SKIP_BUF_GENERATE: "true"  # protoスタブは既に生成済み
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          set-safe-directory: false

      - name: Prepare runner directories
        run: |
          echo "RUNNER_TEMP=$RUNNER_TEMP"
          echo "RUNNER_TOOL_CACHE=$RUNNER_TOOL_CACHE"
          mkdir -p "$RUNNER_TEMP" "$RUNNER_TOOL_CACHE"

      # Flutter SDK のキャッシュを有効化
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true  # Flutter SDKをキャッシュ
          cache-key: flutter-${{ runner.os }}-3.27.0-${{ env.CACHE_KEY_SUFFIX }}

      - name: Verify Flutter
        run: |
          which flutter
          flutter --version

      # Pub packages のキャッシュ
      - name: Cache Pub packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}-${{ env.CACHE_KEY_SUFFIX }}
          restore-keys: |
            pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}-v1
            pub-cache-${{ runner.os }}-

      # Gradle のキャッシュ
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('android/build.gradle', 'android/app/build.gradle', 'android/gradle/wrapper/gradle-wrapper.properties') }}-${{ env.CACHE_KEY_SUFFIX }}
          restore-keys: |
            gradle-${{ runner.os }}-${{ hashFiles('android/build.gradle', 'android/app/build.gradle', 'android/gradle/wrapper/gradle-wrapper.properties') }}-v1
            gradle-${{ runner.os }}-

      # Ruby Bundler のキャッシュ
      - name: Cache Ruby Bundler
        uses: actions/cache@v4
        with:
          path: vendor/bundle
          key: bundler-${{ runner.os }}-${{ hashFiles('Gemfile.lock') }}-${{ env.CACHE_KEY_SUFFIX }}
          restore-keys: |
            bundler-${{ runner.os }}-${{ hashFiles('Gemfile.lock') }}-v1
            bundler-${{ runner.os }}-

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup buf
        uses: bufbuild/buf-setup-action@v1

      - name: Check Ruby
        run: |
          ruby -v
          bundle -v

      - name: Check Java
        run: |
          java -version
          javac -version

      # Android SDK packages のキャッシュ（self-hostedランナーでは既にインストール済みの場合スキップ）
      - name: Install Android SDK packages
        run: |
          # Check if packages are already installed
          if ! sdkmanager --list_installed | grep -q "platforms;android-36"; then
            echo "Installing Android SDK packages..."
            sdkmanager --install \
              "platform-tools" \
              "platforms;android-36" \
              "build-tools;36.0.0"
          else
            echo "Android SDK packages already installed, skipping..."
          fi

      - name: Install dependencies
        run: |
          # Flutter pub get with cache
          flutter pub get
          # Bundle install with deployment mode for faster installs
          cd android/fastlane && bundle config set --local path '../../vendor/bundle' && bundle install --jobs 4 --retry 3

      - name: Generate env.g.dart for CI builds
        run: |
          # Generate env.g.dart directly without using build_runner
          # This avoids conflicts with other generated files
          chmod +x scripts/generate_env_g_dart_for_ci.sh
          ./scripts/generate_env_g_dart_for_ci.sh
          head -20 lib/presentations/env.g.dart

      - name: Generate firebase_options.dart for CI builds
        run: |
          # Generate dummy firebase_options.dart for CI builds
          chmod +x scripts/generate_firebase_options_for_ci.sh
          ./scripts/generate_firebase_options_for_ci.sh

      - name: Generate google-services.json for CI builds
        run: |
          # Generate dummy google-services.json for CI builds
          chmod +x scripts/generate_google_services_for_ci.sh
          ./scripts/generate_google_services_for_ci.sh

      - name: Run fastlane build (debug mode)
        run: |
          make android-build-debug
        continue-on-error: true

      - name: Run fastlane build (test mode - no signing)
        run: |
          make android-build-test

      - name: Run fastlane build (with code signing)
        if: ${{ env.KEYSTORE_FILE != '' && env.KEYSTORE_PASSWORD != '' && env.KEY_ALIAS != '' && env.KEY_PASSWORD != '' }}
        run: |
          make android-build
        continue-on-error: true

      - name: Run fastlane build bundle (for Google Play)
        if: ${{ env.KEYSTORE_FILE != '' && env.KEYSTORE_PASSWORD != '' && env.KEY_ALIAS != '' && env.KEY_PASSWORD != '' }}
        run: |
          make android-build-bundle
        continue-on-error: true

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: |
            build/app/outputs/flutter-apk/
            build/app/outputs/bundle/
          retention-days: 7
          if-no-files-found: ignore

      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build artifacts are available in the workflow artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Debug APK: \`build/app/outputs/flutter-apk/app-debug.apk\`" >> $GITHUB_STEP_SUMMARY
          echo "- Release APK: \`build/app/outputs/flutter-apk/app-release.apk\`" >> $GITHUB_STEP_SUMMARY
          echo "- App Bundle: \`build/app/outputs/bundle/release/app-release.aab\`" >> $GITHUB_STEP_SUMMARY
